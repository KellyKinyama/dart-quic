import 'dart:typed_data';
import 'package:hex/hex.dart';
import '../initial_aead.dart';
import '../protocol.dart';
import '../aead.dart';
import '../packet.dart'; // Import your packet parser
import '../buffer.dart'; // Import your buffer class

void unprotectAndParseInitialPacket(Uint8List packetBytes) {
  print('\n--- Parsing the QUIC Initial Packet ---');
  final mutablePacket = Uint8List.fromList(packetBytes);
  final buffer = mutablePacket.buffer;

  // 1. Use your robust header parser to get accurate offsets and lengths
  final headerInfo = pullQuicHeader(Buffer(data: packetBytes));
  final int headerLength =
      headerInfo.packetLength -
      (ByteData.view(buffer, 21, 2).getUint16(0) & 0x3FFF);
  final int pnOffset =
      headerLength - 2; // Approximation based on this packet's structure

  print("Connection id: ${HEX.encode(headerInfo.destinationCid)}");

  // 2. Derive keys using the correctly parsed DCID
  final (_, opener) = newInitialAEAD(
    headerInfo.destinationCid,
    Perspective.server,
    Version.version1,
  );

  // 3. Unprotect the header
  final sample = Uint8List.view(buffer, pnOffset + 4, 16);
  final firstByteView = Uint8List.view(buffer, 0, 1);
  final protectedPnBytesView = Uint8List.view(buffer, pnOffset, 4);
  opener.decryptHeader(sample, firstByteView, protectedPnBytesView);

  // 4. Decode Packet Number
  final pnLength = (firstByteView[0] & 0x03) + 1;
  int wirePn = 0;
  for (int i = 0; i < pnLength; i++) {
    wirePn = (wirePn << 8) | protectedPnBytesView[i];
  }
  print("Decoded Packet Number: $wirePn");

  // 5. Decrypt Payload using the correct lengths from the header
  final fullPacketNumber = opener.decodePacketNumber(wirePn, pnLength);
  final payloadOffset = pnOffset + pnLength;
  final associatedData = Uint8List.view(buffer, 0, payloadOffset);
  final ciphertext = Uint8List.view(
    buffer,
    payloadOffset,
    headerInfo.packetLength - payloadOffset,
  );

  final plaintext = opener.open(ciphertext, fullPacketNumber, associatedData);
  print('✅ **Payload decrypted successfully!**');
  print(
    '✅ **Recovered Message (Hex): "${HEX.encode(plaintext.sublist(0, 32))}"...**',
  );
}

void main() {
  // 1. Generate a known-good packet using the verified test function.
  // final validPacket = testClientInitialProtection();

  // 2. Parse the valid packet. This will now succeed.
  unprotectAndParseInitialPacket(quicIntialPacket);
}

final quicIntialPacket = Uint8List.fromList([
  202,
  0,
  0,
  0,
  1,
  11,
  247,
  142,
  73,
  69,
  57,
  95,
  35,
  25,
  160,
  60,
  35,
  0,
  0,
  68,
  235,
  89,
  132,
  99,
  229,
  25,
  221,
  55,
  245,
  87,
  171,
  51,
  100,
  139,
  199,
  3,
  161,
  97,
  46,
  209,
  251,
  238,
  166,
  130,
  85,
  59,
  153,
  42,
  68,
  215,
  108,
  254,
  163,
  145,
  92,
  205,
  135,
  192,
  81,
  61,
  14,
  39,
  189,
  251,
  125,
  55,
  148,
  50,
  7,
  92,
  208,
  39,
  14,
  53,
  200,
  155,
  163,
  98,
  91,
  233,
  249,
  76,
  231,
  130,
  149,
  142,
  179,
  169,
  160,
  139,
  72,
  101,
  242,
  46,
  26,
  194,
  64,
  246,
  141,
  17,
  109,
  195,
  150,
  83,
  168,
  170,
  20,
  116,
  175,
  171,
  139,
  180,
  41,
  101,
  148,
  149,
  117,
  160,
  81,
  20,
  174,
  118,
  76,
  64,
  206,
  60,
  224,
  81,
  235,
  142,
  251,
  14,
  15,
  205,
  244,
  89,
  29,
  166,
  105,
  94,
  240,
  16,
  237,
  202,
  251,
  238,
  172,
  220,
  202,
  84,
  50,
  85,
  4,
  235,
  134,
  7,
  88,
  52,
  10,
  2,
  157,
  125,
  202,
  176,
  4,
  144,
  185,
  174,
  242,
  186,
  30,
  159,
  171,
  58,
  66,
  236,
  25,
  28,
  26,
  244,
  102,
  83,
  16,
  152,
  46,
  12,
  114,
  59,
  110,
  138,
  158,
  158,
  126,
  147,
  137,
  52,
  186,
  99,
  115,
  232,
  2,
  63,
  160,
  102,
  240,
  204,
  14,
  85,
  218,
  222,
  194,
  21,
  133,
  170,
  137,
  120,
  17,
  10,
  233,
  34,
  213,
  65,
  79,
  93,
  254,
  40,
  184,
  221,
  33,
  167,
  185,
  140,
  158,
  221,
  234,
  194,
  139,
  72,
  59,
  88,
  79,
  8,
  69,
  184,
  188,
  140,
  159,
  139,
  3,
  113,
  80,
  224,
  100,
  145,
  77,
  42,
  116,
  90,
  221,
  226,
  194,
  204,
  166,
  189,
  115,
  83,
  244,
  39,
  190,
  26,
  152,
  7,
  164,
  66,
  91,
  22,
  243,
  187,
  29,
  165,
  249,
  105,
  161,
  115,
  150,
  151,
  84,
  35,
  15,
  102,
  6,
  79,
  224,
  66,
  65,
  76,
  229,
  94,
  165,
  79,
  193,
  15,
  204,
  131,
  230,
  83,
  8,
  27,
  255,
  85,
  55,
  129,
  9,
  161,
  193,
  55,
  26,
  209,
  184,
  134,
  109,
  223,
  67,
  240,
  117,
  47,
  250,
  215,
  122,
  100,
  70,
  197,
  227,
  155,
  78,
  102,
  63,
  150,
  114,
  185,
  204,
  111,
  9,
  139,
  89,
  66,
  76,
  233,
  10,
  202,
  232,
  238,
  34,
  255,
  64,
  157,
  192,
  86,
  215,
  108,
  210,
  3,
  79,
  90,
  231,
  133,
  62,
  84,
  32,
  178,
  196,
  27,
  53,
  89,
  29,
  72,
  11,
  213,
  60,
  86,
  234,
  177,
  32,
  243,
  172,
  107,
  100,
  66,
  234,
  196,
  12,
  125,
  47,
  93,
  106,
  49,
  54,
  64,
  151,
  255,
  67,
  244,
  136,
  128,
  80,
  130,
  68,
  90,
  181,
  166,
  150,
  7,
  163,
  34,
  210,
  99,
  143,
  107,
  155,
  208,
  157,
  54,
  127,
  101,
  9,
  167,
  218,
  25,
  216,
  139,
  215,
  221,
  127,
  121,
  245,
  156,
  89,
  242,
  14,
  0,
  135,
  150,
  251,
  93,
  224,
  230,
  178,
  58,
  21,
  27,
  44,
  91,
  181,
  90,
  36,
  12,
  18,
  200,
  64,
  232,
  28,
  104,
  238,
  85,
  237,
  102,
  139,
  187,
  13,
  13,
  225,
  40,
  150,
  153,
  105,
  230,
  123,
  97,
  159,
  222,
  219,
  222,
  211,
  24,
  84,
  102,
  223,
  211,
  51,
  62,
  212,
  217,
  44,
  204,
  209,
  234,
  219,
  59,
  213,
  238,
  56,
  244,
  92,
  196,
  79,
  63,
  107,
  237,
  39,
  71,
  66,
  157,
  127,
  136,
  39,
  248,
  0,
  229,
  22,
  126,
  252,
  63,
  194,
  226,
  48,
  62,
  97,
  33,
  197,
  82,
  103,
  246,
  152,
  28,
  201,
  185,
  200,
  108,
  2,
  12,
  68,
  129,
  40,
  8,
  0,
  148,
  228,
  221,
  196,
  208,
  76,
  5,
  123,
  104,
  137,
  97,
  23,
  114,
  102,
  56,
  150,
  205,
  209,
  161,
  227,
  190,
  246,
  106,
  57,
  6,
  173,
  156,
  46,
  138,
  138,
  48,
  144,
  51,
  241,
  183,
  78,
  222,
  238,
  210,
  57,
  236,
  103,
  212,
  139,
  230,
  242,
  32,
  183,
  94,
  94,
  103,
  51,
  134,
  164,
  131,
  191,
  231,
  45,
  43,
  103,
  248,
  31,
  52,
  192,
  167,
  217,
  4,
  129,
  246,
  214,
  17,
  150,
  135,
  0,
  43,
  38,
  241,
  60,
  96,
  134,
  70,
  36,
  166,
  249,
  47,
  208,
  26,
  171,
  4,
  144,
  110,
  239,
  189,
  9,
  223,
  58,
  228,
  73,
  109,
  212,
  129,
  207,
  125,
  91,
  199,
  173,
  2,
  93,
  169,
  104,
  248,
  221,
  188,
  125,
  246,
  180,
  155,
  76,
  128,
  96,
  104,
  148,
  103,
  110,
  242,
  1,
  229,
  140,
  162,
  11,
  116,
  223,
  178,
  106,
  49,
  188,
  56,
  141,
  187,
  146,
  101,
  215,
  113,
  236,
  30,
  40,
  183,
  191,
  105,
  16,
  117,
  180,
  105,
  215,
  203,
  185,
  24,
  32,
  194,
  82,
  24,
  175,
  149,
  54,
  18,
  222,
  215,
  131,
  114,
  56,
  73,
  153,
  149,
  12,
  30,
  10,
  49,
  16,
  33,
  45,
  204,
  8,
  76,
  218,
  45,
  89,
  9,
  129,
  188,
  50,
  237,
  252,
  163,
  169,
  23,
  242,
  140,
  68,
  105,
  206,
  205,
  133,
  164,
  8,
  126,
  238,
  17,
  12,
  79,
  133,
  164,
  145,
  225,
  167,
  62,
  46,
  82,
  10,
  224,
  223,
  80,
  143,
  12,
  126,
  231,
  137,
  165,
  31,
  49,
  131,
  31,
  82,
  230,
  243,
  102,
  214,
  202,
  63,
  106,
  212,
  217,
  109,
  132,
  149,
  199,
  1,
  51,
  118,
  176,
  72,
  149,
  156,
  205,
  239,
  90,
  220,
  141,
  224,
  205,
  205,
  179,
  71,
  122,
  246,
  97,
  201,
  86,
  92,
  207,
  121,
  148,
  82,
  20,
  208,
  249,
  241,
  73,
  49,
  59,
  238,
  38,
  1,
  2,
  116,
  240,
  60,
  80,
  132,
  177,
  57,
  241,
  138,
  228,
  216,
  56,
  89,
  113,
  103,
  218,
  31,
  79,
  73,
  108,
  165,
  210,
  191,
  113,
  41,
  202,
  239,
  94,
  193,
  62,
  47,
  141,
  54,
  242,
  247,
  84,
  187,
  107,
  6,
  155,
  47,
  107,
  8,
  22,
  84,
  244,
  155,
  167,
  120,
  171,
  21,
  189,
  137,
  86,
  154,
  32,
  182,
  134,
  44,
  2,
  43,
  36,
  1,
  195,
  231,
  78,
  11,
  172,
  30,
  51,
  162,
  3,
  52,
  128,
  133,
  200,
  172,
  29,
  203,
  139,
  169,
  5,
  255,
  36,
  55,
  19,
  126,
  20,
  70,
  193,
  154,
  188,
  225,
  174,
  230,
  96,
  47,
  136,
  206,
  202,
  145,
  107,
  171,
  175,
  73,
  134,
  219,
  107,
  127,
  0,
  248,
  24,
  18,
  4,
  29,
  177,
  18,
  254,
  175,
  209,
  110,
  253,
  79,
  112,
  141,
  2,
  234,
  188,
  16,
  164,
  62,
  1,
  7,
  240,
  161,
  1,
  191,
  133,
  138,
  197,
  114,
  72,
  56,
  178,
  5,
  192,
  15,
  119,
  189,
  192,
  38,
  30,
  240,
  29,
  247,
  90,
  30,
  80,
  25,
  232,
  119,
  117,
  245,
  113,
  190,
  1,
  35,
  80,
  210,
  12,
  181,
  147,
  111,
  37,
  180,
  159,
  248,
  39,
  74,
  253,
  170,
  36,
  167,
  204,
  210,
  139,
  148,
  85,
  139,
  97,
  5,
  33,
  104,
  91,
  61,
  91,
  222,
  177,
  184,
  37,
  78,
  26,
  204,
  243,
  200,
  76,
  30,
  113,
  63,
  60,
  196,
  245,
  179,
  95,
  63,
  43,
  135,
  50,
  29,
  142,
  235,
  101,
  213,
  149,
  159,
  252,
  57,
  233,
  59,
  187,
  63,
  60,
  195,
  90,
  225,
  63,
  166,
  77,
  107,
  231,
  103,
  3,
  184,
  70,
  209,
  48,
  247,
  25,
  182,
  37,
  171,
  219,
  43,
  147,
  21,
  191,
  142,
  84,
  110,
  118,
  255,
  177,
  226,
  204,
  153,
  89,
  158,
  95,
  26,
  78,
  98,
  79,
  39,
  167,
  195,
  239,
  186,
  26,
  214,
  248,
  54,
  197,
  150,
  223,
  181,
  199,
  255,
  69,
  78,
  161,
  203,
  226,
  203,
  20,
  225,
  235,
  149,
  180,
  169,
  73,
  5,
  89,
  138,
  12,
  104,
  198,
  155,
  42,
  71,
  246,
  122,
  19,
  138,
  207,
  9,
  183,
  152,
  42,
  191,
  6,
  183,
  111,
  6,
  160,
  148,
  38,
  28,
  207,
  194,
  41,
  181,
  86,
  246,
  42,
  212,
  247,
  60,
  125,
  156,
  53,
  53,
  233,
  59,
  185,
  58,
  185,
  186,
  16,
  186,
  106,
  54,
  0,
  161,
  134,
  253,
  67,
  80,
  183,
  91,
  58,
  8,
  156,
  26,
  96,
  185,
  41,
  177,
  55,
  196,
  135,
  236,
  7,
  90,
  253,
  130,
  86,
  185,
  192,
  183,
  177,
  178,
  99,
  234,
  46,
  130,
  180,
  114,
  17,
  41,
  87,
  235,
  141,
  166,
  139,
  202,
  23,
  174,
  27,
  130,
  147,
  116,
  40,
  198,
  143,
  202,
  115,
  193,
  3,
  213,
  69,
  45,
  196,
  224,
  147,
  223,
  170,
  59,
  164,
  42,
  125,
  191,
  16,
  108,
  96,
  167,
  31,
  109,
  191,
  90,
  108,
  117,
  131,
  27,
  11,
  180,
  63,
  152,
  67,
  223,
  244,
  144,
  10,
  64,
  183,
  17,
  159,
  210,
  255,
  241,
  211,
  106,
  65,
]);
